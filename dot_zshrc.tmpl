eval "$(starship init zsh)"

# starship
PYENV_VIRTUALENV_DISABLE_PROMPT=1

# general
export EDITOR=nvim
export LANG=en_US.UTF-8
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export HISTFILE="$HOME/.zsh_history"
autoload -Uz colors
colors
bindkey -e

# direnv
eval "$(direnv hook zsh)"

# asdf
{{ if eq .chezmoi.os "darwin" }}
. /opt/homebrew/opt/asdf/libexec/asdf.sh
# fpath=(${ASDF_DIR}/completions $fpath)
source "${XDG_CONFIG_HOME:-$HOME/.config}/asdf-direnv/zshrc"
{{ end }}
{{ if eq .chezmoi.os "linux" }}
. "$HOME/.asdf/asdf.sh"
{{ end }}

# Java
{{ if eq .chezmoi.os "darwin" }}
export PATH="/opt/homebrew/opt/openjdk@11/bin:$PATH"
export CPPFLAGS="-I/opt/homebrew/opt/openjdk@11/include"
{{ end }}

# PHP
{{ if eq .chezmoi.os "darwin" }}
export PATH="/opt/homebrew/opt/php@8.0/bin:$PATH"
export PATH="/opt/homebrew/opt/php@8.0/sbin:$PATH"
{{ end }}

# Go
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin

# flutter
export PATH="$PATH:$HOME/dev/flutter/bin"

# nvm
{{ if eq .chezmoi.os "darwin" }}
export NVM_DIR="$HOME/.nvm"
  [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
  [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion
{{ end }}

# options
setopt print_eight_bit
setopt no_beep
setopt nolistbeep
setopt ignoreeof
setopt extended_glob
setopt notify
setopt magic_equal_subst

# history
setopt auto_pushd
setopt share_history
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_reduce_blanks
setopt pushd_ignore_dups
setopt hist_ignore_all_dups
HISTSIZE=100000
SAVEHIST=100000

# completions
autoload -Uz compinit && compinit
zstyle ':completion:*' completer _complete _approximate _prefix

# aliases
alias vi="nvim -u ~/.vimrc"
alias vim="nvim"
alias view="nvim -R"
alias tl='tldr'
alias av='aws-vault'
{{ if eq .chezmoi.os "darwin" }}
alias ls="exa --sort=ext" 
alias tree="exa -T"
alias df="duf"
alias lg='lazygit'
{{ end }}

# fish-like behavior
{{ if eq .chezmoi.os "darwin"  }}
{{ end }}
source `brew --prefix`/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
if type brew &>/dev/null; then
    FPATH=$(brew --prefix)/share/zsh-completions:$FPATH
    FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi

# zsh-autosuggestions
{{ if eq .chezmoi.os "darwin" }}
source `brew --prefix`/share/zsh-autosuggestions/zsh-autosuggestions.zsh
{{ end }}
{{ if eq .chezmoi.os "linux" }}
source `brew --prefix`/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fpath=(${ASDF_DIR}/completions $fpath)
{{ end }}

# zoxide
eval "$(zoxide init zsh)"

# configs of fzf
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!**/.git/*"'
export FZF_DEFAULT_OPTS="--height 40% --reverse --prompt='? '"

# for finding files in current directories
export FZF_CTRL_T_COMMAND='rg --files --hidden --follow --glob "!**/.git/*"'
export FZF_CTRL_T_OPTS=""

# fghq (ghq)
function _ghq_fzf() {
    local src=$(ghq list | fzf)
    if [ -n "$src" ]; then
        BUFFER="cd $(ghq root)/$src"
        zle accept-line
    fi
    zle -R -c
}
zle -N _ghq_fzf
bindkey '^g' _ghq_fzf

# fco (git checkout) - checkout git branch including remote branches
# ref: https://qiita.com/kamykn/items/aa9920f07487559c0c7e
fco() {
    local branches branch
    branches=$(git branch --all | grep -v HEAD) &&
    branch=$(echo "$branches" |
            fzf -d $(( 2 + $(wc -l <<< "$branches") )) +m) &&
    git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
}

# flog - git commit browser
# ref: https://qiita.com/kamykn/items/aa9920f07487559c0c7e
flog() {
    git log --graph --color=always \
        --format="%C(auto)%h%d %s %C(#C0C0C0)%C(bold)%cr" "$@" |
    fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort \
        --bind "ctrl-m:execute:
              (grep -o '[a-f0-9]\{7\}' | head -1 |
              xargs -I % sh -c 'git diff %') << 'FZF-EOF'
              {}
FZF-EOF"
}

# Enter docker containers with fzf
# ref: https://momozo.tech/2021/03/10/fzf%E3%81%A7zsh%E3%82%BF%E3%83%BC%E3%83%9F%E3%83%8A%E3%83%AB%E4%BD%9C%E6%A5%AD%E3%82%92%E5%8A%B9%E7%8E%87%E5%8C%96/
fcon() {
    local cid
    cid=$(docker ps | sed 1d | fzf -q "$1" | awk '{print $1}')
    [ -n "$cid" ] && docker exec -it "$cid" /bin/bash
}

# Show docker logs with fzf
# ref: https://momozo.tech/2021/03/10/fzf%E3%81%A7zsh%E3%82%BF%E3%83%BC%E3%83%9F%E3%83%8A%E3%83%AB%E4%BD%9C%E6%A5%AD%E3%82%92%E5%8A%B9%E7%8E%87%E5%8C%96/
fdl() {
    local cid
    cid=$(docker ps -a | sed 1d | fzf -q "$1" | awk '{print $1}')
    [ -n "$cid" ] && docker logs -f --tail=200 "$cid"
}

# the fuck
eval $(thefuck --alias)

# cd today's sandbox
today() {
    local date="$(date -u +%m%d)"
    local dirpath="$HOME/dev/sandbox/daily/$date"
    if [ ! -e $dirpath ]; then
        mkdir -p $dirpath
    fi
    cd $dirpath
}

# open repository in browser
repo() {
    local remote_name=${1:-origin}
    local repo_url=$(git remote -vv | awk -v pattern="$remote_name" '$1 == pattern && $3 == "(fetch)" {print $2}')

    if [ -n "$SSH_CONNECTION" ]; then
        echo "$repo_url"
        return 0
    fi

    if [ ! -x "$(command -v open)" ]; then
        echo "open command is not found"
        echo $repo_url
        return 1
    fi

    if [ -z "$repo_url" ]; then
        echo "$1 is an invalid remote repo's name."
        return 1
    fi

    echo "$repo_url"
    open -a "Google Chrome" "$repo_url"

    return 0
}

# colorlized man
man() {
    LESS_TERMCAP_md=$'\e[01;34m' \
    LESS_TERMCAP_me=$'\e[0m' \
    LESS_TERMCAP_se=$'\e[0m' \
    LESS_TERMCAP_so=$'\e[01;4;31m' \
    LESS_TERMCAP_ue=$'\e[0m' \
    LESS_TERMCAP_us=$'\e[01;36m' \
    command man "$@"
}

# pet
function pet-select() {
  BUFFER=$(pet search --query "$LBUFFER")
  CURSOR=$#BUFFER
  zle redisplay
}
zle -N pet-select
stty -ixon
bindkey '^s' pet-select

function prev() {
  PREV=$(fc -lrn | head -n 1)
  sh -c "pet new `printf %q "$PREV"`"
}
