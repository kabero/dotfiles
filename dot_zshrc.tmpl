# starship
PYENV_VIRTUALENV_DISABLE_PROMPT=1

# general
export EDITOR=nvim
export LANG=en_US.UTF-8
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export HISTFILE="$HOME/.zsh_history"
autoload -Uz colors
colors
bindkey -e

# asdf
{{ if eq .chezmoi.os "darwin" }}
{{ if eq .chezmoi.arch "arm64" }}
. /opt/homebrew/opt/asdf/libexec/asdf.sh
{{ end }}
# fpath=(${ASDF_DIR}/completions $fpath)
# source "${XDG_CONFIG_HOME:-$HOME/.config}/asdf-direnv/zshrc"
{{ end }}
{{ if eq .chezmoi.os "linux" }}
. "$HOME/.asdf/asdf.sh"
{{ end }}

# Java
{{ if eq .chezmoi.os "darwin" }}
export PATH="/opt/homebrew/opt/openjdk@11/bin:$PATH"
export CPPFLAGS="-I/opt/homebrew/opt/openjdk@11/include"
{{ end }}

# PHP
{{ if eq .chezmoi.os "darwin" }}
export PATH="/opt/homebrew/opt/php@8.1/bin:$PATH"
export PATH="/opt/homebrew/opt/php@8.1/sbin:$PATH"
{{ end }}

# Go
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin

# flutter
export PATH="$PATH:$HOME/dev/flutter/bin"

# nvm
{{ if eq .chezmoi.os "darwin" }}
export NVM_DIR="$HOME/.nvm"
  [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
  [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion
{{ end }}

export PATH="$HOME/.local/bin:$PATH"

# options
setopt print_eight_bit
setopt no_beep
setopt nolistbeep
setopt ignoreeof
setopt extended_glob
setopt notify
setopt magic_equal_subst

# history
setopt auto_pushd
setopt append_history
setopt hist_ignore_all_dups
setopt hist_ignore_dups
setopt hist_reduce_blanks
setopt pushd_ignore_dups
setopt share_history
setopt inc_append_history
HISTSIZE=100000
SAVEHIST=100000

# completions
if [ -e ~/.zsh/completions ]; then
    fpath=(~/.zsh/completions $fpath)
fi
autoload -Uz compinit && compinit
zstyle ':completion:*' completer _complete _approximate _prefix

# aliases
alias vim="nvim"
alias view="nvim -R"
alias tl='tldr'
alias ls="eza --sort=ext"
alias tree="eza -T"
alias df="duf"
alias grepc="grep --color=always"
alias teee='tee >(pbcopy)'
alias av='aws-vault'
alias ave='aws-vault exec'
alias code='cursor'
alias dbash='docker build -t tmp . && docker run -it --rm --entrypoint /bin/bash tmp'

# fish-like behavior
source `brew --prefix`/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
if type brew &>/dev/null; then
    FPATH=$(brew --prefix)/share/zsh-completions:$FPATH
    FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi

# zsh-autosuggestions
{{ if eq .chezmoi.os "darwin" }}
source `brew --prefix`/share/zsh-autosuggestions/zsh-autosuggestions.zsh
{{ end }}
{{ if eq .chezmoi.os "linux" }}
source `brew --prefix`/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fpath=(${ASDF_DIR}/completions $fpath)
{{ end }}

# initialize
function command_exists() {
    command -v "$1" >/dev/null 2>&1
}

z() {
    unset -f z
    eval "$(zoxide init zsh)"
    __zoxide_z "$@"
}

gh() {
    unset -f gh
    eval "$(gh completion -s zsh)"
    gh "$@"
}

direnv() {
    unset -f direnv
    eval "$(direnv hook zsh)"
    direnv "$@"
}

command_exists starship && eval "$(starship init zsh)"

# fzf
if command_exists fzf; then
    [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
    export FZF_COMPLETION_TRIGGER=","
    export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!**/.git/*"'
    export FZF_DEFAULT_OPTS="--height 50% --reverse --prompt='/ ' --bind=ctrl-k:kill-line,ctrl-d:preview-down,ctrl-u:preview-up"

    # for finding files in current directories
    export FZF_CTRL_T_COMMAND='rg --files --hidden --follow --glob "!**/.git/*"'
    export FZF_CTRL_T_OPTS="--prompt='FILES> '"

    # Enhanced <c-r>
    function select-history() {
        local original_buffer=$BUFFER
        local query=$LBUFFER
        local result=$(history -n -r 1 | fzf +m --print-query --query "$query" --prompt="CMD> ")
        if [ -n "$result" ]; then
            BUFFER=$(echo "$result" | tail -n 1)
        else
            BUFFER=$query
        fi
        CURSOR=$#BUFFER
        zle redisplay
    }
    zle -N select-history
    bindkey '^r' select-history

    # Enhanced <c-t>
    function select-file() {
        local result=$(rg --files --hidden --follow --glob "!**/.git/*" | fzf +m --prompt="FILES> ")
        if [ -n "$result" ]; then
            if [ -d "$result" ]; then
                BUFFER="cd $result"
                zle accept-line
            else
                BUFFER="nvim $result"
                zle accept-line
            fi
        fi
        zle redisplay
    }
    zle -N select-file
    bindkey '^t' select-file

    # Open repo with <c-g>
    function _ghq_fzf() {
        local src=$(ghq list | fzf --prompt "GHQ> ")
        zle redisplay
        if [ -n "$src" ]; then
            BUFFER="cd $(ghq root)/$src"
            zle accept-line
        fi
        zle -R -c
    }
    zle -N _ghq_fzf
    bindkey '^g' _ghq_fzf

    # cd (fzf + zoxide) with zz
    zz() {
        local dirpath=$(zoxide query -l | sed "s|$HOME|~|g" | fzf --prompt "CD> " --preview="eval echo {} | sed 's|~|$HOME|' | xargs exa -a --oneline --sort=ext")
        cd $(eval echo $(echo $dirpath | sed 's|~|$HOME|'))
    }
fi

# copy the previous command
ppp() {
    prev_cmd=$(history -n | tail -n 1)
    echo "\"$prev_cmd\" copied!"
    echo -n $prev_cmd | pbcopy
}

# colorlized man pages
man() {
    LESS_TERMCAP_md=$'\e[01;34m' \
    LESS_TERMCAP_me=$'\e[0m' \
    LESS_TERMCAP_se=$'\e[0m' \
    LESS_TERMCAP_so=$'\e[01;4;31m' \
    LESS_TERMCAP_ue=$'\e[0m' \
    LESS_TERMCAP_us=$'\e[01;36m' \
    command man "$@"
}


# open note
v() {
    vi ~/notes/$(uuidgen).md
}

# tmpfile
vv() {
    echo ~/notes/$(uuidgen).txt
}

# docker compose
d() {
    docker compose exec $@
}

# ssh
function ssh() {
  if [[ -n $(printenv TMUX) ]] ; then
      local pane_id=$(tmux display -p '#{pane_id}')
      local original_bg=$(tmux show-options -gqv pane-active-border-style | grep -o 'bg=[^,]*')

      if [[ `echo $1 | grep -E 'prd|prod|production'` ]] ; then
          tmux select-pane -P 'bg=#330000'
      elif [[ `echo $1 | grep -E 'stg|staging'` ]] ; then
          tmux select-pane -P 'bg=#000033'
      fi

      command ssh "$@"

      tmux select-pane -t $pane_id -P "$original_bg"
  else
      command ssh "$@"
  fi
}

alias c='claude'

function ccommit() {
    changed_files=$(git diff --cached --name-only)
    if [ -z "$changed_files" ]; then
        echo "No changes to commit."
        return 1
    fi
    claude_prompt="ÁèæÂú®„Çπ„ÉÜ„Éº„Ç∏„Åï„Çå„Å¶„ÅÑ„Çã„Éï„Ç°„Ç§„É´„Å´„Å§„ÅÑ„Å¶„ÄÅ„Åù„ÅÆÂ§âÊõ¥ÁÇπ„ÇíË∏è„Åæ„Åà„Å¶prefix‰ªò„Åç„ÅÆ„Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏(Êó•Êú¨Ë™û)„ÇíËÄÉ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇex) fix: <commit message>"
    claude -p $claude_prompt | tee >(pbcopy)
}

function ccommand() {
    _prompt="$* ...„Åì„ÅÆ„Çà„ÅÜ„Å™„Ç∑„Çß„É´„Ç≥„Éû„É≥„Éâ„Çí„ÉØ„É≥„É©„Ç§„Éä„Éº„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
    claude -p $_prompt | tee >(pbcopy)
}

# Project status command
function status() {
    # Colors
    local BLUE='\033[1;34m'
    local GREEN='\033[1;32m'
    local YELLOW='\033[1;33m'
    local RED='\033[1;31m'
    local PURPLE='\033[1;35m'
    local CYAN='\033[1;36m'
    local NC='\033[0m'

    # Current directory information
    echo "${BLUE}üìÅ Directory:${NC} $(pwd)"
    echo "${GREEN}üìä Size:${NC} $(du -sh . | cut -f1)"
    
    if [ -d .git ]; then
        echo "${YELLOW}üìù Git Files:${NC} $(git ls-files | wc -l | tr -d ' ')"
        echo "${YELLOW}üìÅ Git Directories:${NC} $(git ls-files | xargs dirname | sort -u | wc -l | tr -d ' ')"
        echo "${YELLOW}üì¶ Git Size:${NC} $(git count-objects -vH | grep size-pack | cut -d: -f2 | tr -d ' ')"
    else
        echo "${YELLOW}üìù Files:${NC} $(find . -type f | wc -l | tr -d ' ')"
        echo "${YELLOW}üìÅ Directories:${NC} $(find . -type d | wc -l | tr -d ' ')"
    fi
    echo ""

    # Git information
    if [ -d .git ]; then
        echo "${GREEN}üåø Git Status:${NC}"
        git status -sb
        echo ""
        echo "${PURPLE}üìä Git Stats:${NC}"
        echo "  ${CYAN}Commits:${NC} $(git rev-list --count HEAD)"
        echo "  ${CYAN}Branches:${NC} $(git branch | wc -l | tr -d ' ')"
        echo "  ${CYAN}Tags:${NC} $(git tag | wc -l | tr -d ' ')"
        echo "  ${CYAN}Contributors:${NC} $(git shortlog -s | wc -l | tr -d ' ')"
        echo "  ${CYAN}Stashes:${NC} $(git stash list | wc -l | tr -d ' ')"
        echo "  ${CYAN}Remotes:${NC} $(git remote -v | wc -l | tr -d ' ')"
        echo ""
        echo "${YELLOW}üìÖ Last Commit:${NC}"
        git log -1 --pretty=format:"  %C(yellow)%h%Creset %C(green)%an%Creset %C(blue)%ar%Creset%n  %s"
        echo ""
        echo "${RED}üìà Recent Activity:${NC}"
        git log --since="1 week ago" --pretty=format:"  %C(yellow)%h%Creset %C(green)%an%Creset %C(blue)%ar%Creset %s" | head -n 5
    else
        echo "${RED}‚ùå Not a git repository${NC}"
    fi

    # Dependencies information
    if [ -f package.json ]; then
        echo ""
        echo "${BLUE}üì¶ Node.js Dependencies:${NC}"
        echo "  ${CYAN}Dependencies:${NC} $(jq -r '.dependencies | length' package.json)"
        echo "  ${CYAN}DevDependencies:${NC} $(jq -r '.devDependencies | length' package.json)"
        echo "  ${CYAN}Scripts:${NC} $(jq -r '.scripts | length' package.json)"
        if [ -f package-lock.json ]; then
            echo "  ${CYAN}Lockfile:${NC} $(jq -r '.packages | length' package-lock.json)"
        fi
    fi

    if [ -f go.mod ]; then
        echo ""
        echo "${GREEN}üì¶ Go Dependencies:${NC}"
        echo "  ${CYAN}Dependencies:${NC} $(go list -m all | wc -l | tr -d ' ')"
        echo "  ${CYAN}Go Version:${NC} $(go version | cut -d' ' -f3)"
    fi

    if [ -f requirements.txt ]; then
        echo ""
        echo "${YELLOW}üì¶ Python Dependencies:${NC}"
        echo "  ${CYAN}Dependencies:${NC} $(wc -l requirements.txt | awk '{print $1}')"
        if [ -f Pipfile ]; then
            echo "  ${CYAN}Pipfile Dependencies:${NC} $(jq -r '.default | length' Pipfile.lock 2>/dev/null || echo 0)"
        fi
    fi

    # Docker information
    if [ -f docker-compose.yml ]; then
        echo ""
        echo "${BLUE}üê≥ Docker:${NC}"
        echo "  ${CYAN}Services:${NC} $(docker-compose config --services | wc -l | tr -d ' ')"
        echo "  ${CYAN}Networks:${NC} $(docker-compose config --networks | jq -r 'keys | length')"
        echo "  ${CYAN}Volumes:${NC} $(docker-compose config --volumes | jq -r 'keys | length')"
    fi

    # File types information
    if [ -d .git ]; then
        echo ""
        echo "${PURPLE}üìÑ File Extensions:${NC}"
        git ls-files | grep -v '^\.' | sed 's/.*\.//' | sort | uniq -c | sort -nr | head -n 5 | awk '{print "  ." $2 ": " $1}'
    fi
}
